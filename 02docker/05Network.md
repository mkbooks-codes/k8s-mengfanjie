# docker 网络
## 默认模式– 网桥和 NAT
### 启动容器
```
docker run -it -p 8888:80 nginx
```
```
➜  k8s-mengfanjie git:(main) ✗ docker ps|grep nginx
0a8a3b732dc6   nginx     "/docker-entrypoint.…"   15 seconds ago   Up 14 seconds   0.0.0.0:8888->80/tcp, :::8888->80/tcp   kind_shaw
```
### 查看 bridge
```
➜  k8s-mengfanjie git:(main) ✗ brctl show
bridge name     bridge id               STP enabled     interfaces
br-492d889e2586         8000.02428770a86f       no
br-5acad026af69         8000.024277a930f4       no
br-aaa5b9ea3864         8000.0242e4d9b4e9       no
br-c95e5f3e6eb8         8000.02428a8f7aa5       no
br-d0c2a2aec896         8000.024250dada55       no
docker0         8000.024291851098       no              vetha05e76b
virbr0          8000.525400224c1e       yes             virbr0-nic
```
查看容器进程号
```
➜  k8s-mengfanjie git:(main) ✗ docker inspect 0a8a3b732dc6|grep -i pid
            "Pid": 45377,
            "PidMode": "",
            "PidsLimit": null,
```
查看容器 IP
```
➜  k8s-mengfanjie git:(main) ✗ sudo nsenter -t 45377 -n ip a 
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
13: eth0@if14: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default 
    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
       valid_lft forever preferred_lft forever
```
查看容器路由表
```
➜  k8s-mengfanjie git:(main) ✗ sudo nsenter -t 45377 -n ip r         
default via 172.17.0.1 dev eth0 
172.17.0.0/16 dev eth0 proto kernel scope link src 172.17.0.2
```
通过容器网络访问容器
```
➜  k8s-mengfanjie git:(main) ✗ curl 172.17.0.2 
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
```
通过宿主机网络访问容器
```
➜  k8s-mengfanjie git:(main) ✗ curl localhost:8888
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
```
查看宿主机 iptables
```
➜  k8s-mengfanjie git:(main) ✗ sudo iptables-save -t nat
# Generated by iptables-save v1.8.4 on Sat Oct 15 20:38:34 2022
*nat
:PREROUTING ACCEPT [17:3325]
:INPUT ACCEPT [1:109]
:OUTPUT ACCEPT [161:15109]
:POSTROUTING ACCEPT [161:15109]
:DOCKER - [0:0]
:LIBVIRT_PRT - [0:0]
-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER
-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER
-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE
-A POSTROUTING -s 172.19.0.0/16 ! -o br-d0c2a2aec896 -j MASQUERADE
-A POSTROUTING -s 172.21.0.0/16 ! -o br-c95e5f3e6eb8 -j MASQUERADE
-A POSTROUTING -s 172.18.0.0/16 ! -o br-aaa5b9ea3864 -j MASQUERADE
-A POSTROUTING -s 172.22.0.0/16 ! -o br-5acad026af69 -j MASQUERADE
-A POSTROUTING -s 172.20.0.0/16 ! -o br-492d889e2586 -j MASQUERADE
-A POSTROUTING -j LIBVIRT_PRT
-A POSTROUTING -s 172.17.0.2/32 -d 172.17.0.2/32 -p tcp -m tcp --dport 80 -j MASQUERADE
-A DOCKER -i docker0 -j RETURN
-A DOCKER -i br-d0c2a2aec896 -j RETURN
-A DOCKER -i br-c95e5f3e6eb8 -j RETURN
-A DOCKER -i br-aaa5b9ea3864 -j RETURN
-A DOCKER -i br-5acad026af69 -j RETURN
-A DOCKER -i br-492d889e2586 -j RETURN
-A DOCKER ! -i docker0 -p tcp -m tcp --dport 8888 -j DNAT --to-destination 172.17.0.2:80
-A LIBVIRT_PRT -s 192.168.1.0/24 -d 224.0.0.0/24 -j RETURN
-A LIBVIRT_PRT -s 192.168.1.0/24 -d 255.255.255.255/32 -j RETURN
-A LIBVIRT_PRT -s 192.168.1.0/24 ! -d 192.168.1.0/24 -p tcp -j MASQUERADE --to-ports 1024-65535
-A LIBVIRT_PRT -s 192.168.1.0/24 ! -d 192.168.1.0/24 -p udp -j MASQUERADE --to-ports 1024-65535
-A LIBVIRT_PRT -s 192.168.1.0/24 ! -d 192.168.1.0/24 -j MASQUERADE
COMMIT
# Completed on Sat Oct 15 20:38:34 2022
```
解析 `-A DOCKER ! -i docker0 -p tcp -m tcp --dport 8888 -j DNAT --to-destination 172.17.0.2:80`

- -p tcp: tcp 的请求
- --dport 8888: 目标端口是 8888
- --to-destination 172.17.0.2:80 : 把请求转到 172.17.0.2:80

## Null 模式
### create network ns
```
sudo mkdir -p /var/run/netns
find -L /var/run/netns -type l -delete
```
### start nginx docker with non network mode
```
docker run --network=none  -d nginx
```
### check corresponding pid
```
docker ps|grep nginx
docker inspect <containerid>|grep -i pid

"Pid": 57931,
"PidMode": "",
"PidsLimit": null,
```
### check network config for the container
```
sudo nsenter -t 57931 -n ip a

1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
```
### link network namespace
```
export pid=57931
sudo ln -s /proc/$pid/ns/net /var/run/netns/$pid
ip netns list
```
### check docker bridge on the host 
```
brctl show
ip a
9: docker0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default 
    link/ether 02:42:91:85:10:98 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:91ff:fe85:1098/64 scope link 
       valid_lft forever preferred_lft forever
```
### create veth pair
```
sudo ip link add A type veth peer name B
```
### config A
```
sudo brctl addif docker0 A
sudo ip link set A up
```
### config B
测试 ip 是否在使用，以保证 IP 可用
```
ping 172.17.0.10
```
```
SETIP=172.17.0.10
SETMASK=16
GATEWAY=172.17.0.1

sudo ip link set B netns $pid
sudo ip netns exec $pid ip link set dev B name eth0
sudo ip netns exec $pid ip link set eth0 up
sudo ip netns exec $pid ip addr add $SETIP/$SETMASK dev eth0
sudo ip netns exec $pid ip route add default via $GATEWAY
```
### check connectivity
```
curl 172.17.0.10

<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
```
### 扫尾
```
sudo rm -rf /var/run/netns
```
